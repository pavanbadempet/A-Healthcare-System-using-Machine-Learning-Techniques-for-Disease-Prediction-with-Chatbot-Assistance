from fpdf import FPDF
import datetime

class PDFReport(FPDF):
    def header(self):
        # Logo or Title
        self.set_font('Arial', 'B', 15)
        self.cell(80)
        self.cell(30, 10, 'AI Healthcare System', 0, 0, 'C')
        self.ln(20)
        
        # Line break
        self.set_draw_color(0, 210, 255) # AIO Blue
        self.set_line_width(1)
        self.line(10, 25, 200, 25)
        self.ln(10)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(128)
        self.cell(0, 10, f'Page {self.page_no()}', 0, 0, 'C')
        self.cell(0, 10, 'Generated by AI - Not a Diagnosis', 0, 0, 'R')

def generate_medical_report(user_name: str, report_type: str, prediction: str, data: dict, advice: list = []):
    """
    Generates a professional PDF medical report.
    """
    pdf = PDFReport()
    pdf.add_page()
    
    # Title
    pdf.set_font('Arial', 'B', 16)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(0, 10, f'Medical Analysis Report: {report_type}', 0, 1, 'L')
    
    # Metadata
    pdf.set_font('Arial', '', 10)
    pdf.cell(0, 6, f'Patient Name: {user_name}', 0, 1)
    pdf.cell(0, 6, f'Date: {datetime.datetime.now().strftime("%Y-%m-%d %H:%M")}', 0, 1)
    pdf.cell(0, 6, f'Report ID: AIO-{datetime.datetime.now().strftime("%H%M%S")}', 0, 1)
    pdf.ln(10)
    
    # Result Section
    pdf.set_fill_color(240, 240, 240)
    pdf.rect(10, pdf.get_y(), 190, 20, 'F')
    pdf.set_font('Arial', 'B', 12)
    color = (200, 0, 0) if "High" in prediction else (0, 128, 0)
    pdf.set_text_color(*color)
    pdf.cell(0, 20, f'   Analysis Result: {prediction}', 0, 1, 'L')
    pdf.set_text_color(0)
    pdf.ln(10)
    
    # Clinical Data
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, 'Clinical Parameters Analyzed', 0, 1)
    pdf.set_font('Arial', '', 10)
    
    for key, val in data.items():
        # Format key nicely
        key_fmt = key.replace("_", " ").title()
        pdf.cell(90, 8, f'{key_fmt}', 1)
        pdf.cell(90, 8, f'{val}', 1, 1)
        
    pdf.ln(10)
    
    # AI Advice
    if advice:
        pdf.set_font('Arial', 'B', 12)
        pdf.cell(0, 10, 'AI Recommendations (Wellness Tips)', 0, 1)
        pdf.set_font('Arial', '', 10)
        for tip in advice:
            pdf.multi_cell(0, 8, f'- {tip}')
            
    # Disclaimer
    pdf.ln(20)
    pdf.set_font('Arial', 'I', 9)
    pdf.set_text_color(100)
    pdf.multi_cell(0, 5, "DISCLAIMER: This report is generated by an Artificial Intelligence system for informational purposes only. It is NOT a substitute for a diagnosis by a Registered Medical Practitioner (RMP). Please consult a doctor for official medical advice.")
    
    return pdf.output(dest='S').encode('latin1') # Return bytes
